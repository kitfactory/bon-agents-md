# bon-agents-md アーキテクチャ

本設計は、`bon` CLI が AGENTS.md を生成するまでのレイヤー構造と責務分担を示す。単一責務・DI 可能な抽象境界を重視し、ゴッドクラス化を避ける。

## 目標と制約
- npm グローバル CLI (`bon`) として動作し、Node.js 16+ を前提。
- 対応 AI エディタ: codex / cursor / claudecode / copilot（未指定は codex）。
- 対応言語: Python / JavaScript / TypeScript / Rust（未指定は Python）。
- ロケール判定: ユーザー指定 > `LANG`/`LC_ALL` > OS 推定。WSL では Windows 側言語を優先。判定不可は英語。
- `.env.sample` は生成しない。AGENTS.md に環境変数・`.env` の設定例と利用箇所を明示する。
- AGENTS.md 自体にはプロジェクト固有情報を直接持たせず、`docs/`（concept/spec/architecture など）を参照してプロジェクトを把握するよう誘導する共通テンプレートとする。

## レイヤー構成

### 1) CLI インターフェース層
- 入力: process.argv
- 責務: オプション解析（`--dir`, `--force`, `--lang`, `--editor`, `--help`, `--version`）。パース結果をアプリケーション層へ渡す。
- 実装指針: 小さなパーサ関数に分割。help/version は早期 return。エラーはユーザー向けメッセージで終了コード 1。

### 2) コンテキスト判定層（抽象化ポイント）
- 入力: CLI オプション、環境変数 (`LANG`, `LC_ALL`)、OS/WSL 情報。
- 責務:
  - ロケール決定（日本語/英語）。
  - 言語決定（Python/JS/TS/Rust）。
  - エディタ決定（codex/cursor/claudecode/copilot）。
- 抽象境界: `LocaleDetector`, `LanguageSelector`, `EditorSelector` といったインターフェースを用意し、テストでモック可能にする。WSL 判定や Windows 言語取得は専用ユーティリティに分離。

### 3) テンプレート選択/構成層
- 入力: 言語、エディタ、ロケール。
- 責務: 言語別（Python/JS/TS/Rust）× ロケール別（日/英）テンプレートスニペットの組み立て。共通パート（要件定義、仕様記法、設計指針、テスト方針、環境変数指示）を注入。
- 抽象境界: `TemplateProvider`（データ）、`TemplateRenderer`（文字列化）。データとレンダリングを分離し、ユニットテストで差し替え可能にする。

### 4) 出力層（ファイル I/O）
- 入力: 生成文字列、`--dir`、`--force`。
- 責務: ディレクトリ作成、既存 AGENTS.md の存在確認、`--force` に応じた上書き、ファイル書き出し。
- 抽象境界: `FileWriter` として fs への依存を隔離し、テストでモック/スタブを差し替えられるようにする。

### 5) ロギング/エラーハンドリング
- 責務: ユーザー向けに簡潔なログを出す。失敗時は原因を明示し終了コードを 1 にする。
- デバッグ補助: テスト難航時に段階的メッセージを追加できるよう、ログユーティリティを薄く用意する（標準出力/標準エラーのどちらに出すかを明確化）。

## AGENTS.md に含める内容（生成テンプレートの骨子）
- 要件定義: 想定ユーザー、困りごと、ユースケース、機能一覧、使用ライブラリ、全体設計。
- 仕様/要求仕様: 英語は Given/When/Then、日本語は 前提/条件/振る舞い。
- 設計: レイヤー構造・単一責務・抽象クラス/DI 指針。ゴッドクラス/雑多ヘルパー禁止。シンプルなインターフェースを提示。
- テスト方針: 機能・レイヤー単位で完了。モックは補助、本番経路（実通信/実接続）が通ったら完了。必要な環境変数・接続情報・`.env` の配置場所と設定例を記載（`.env.sample` は生成しない）。難航時はステップごとにデバッグログを追加するよう指示。
- ドキュメント参照: AGENTS.md から `docs/` の concept/spec/architecture を参照し、プロジェクト固有の背景・設計詳細を取得するよう案内する。

## 言語別テンプレート指針
- Python: `uv` + `.venv` 仮想環境、`pytest`、Lint/Format（`ruff`/`black` など）。必要な環境変数例を示し、`.env` の利用箇所を明記する。
- JavaScript: Node.js + `pnpm`/`npm`、テスト（Vitest/Jest）、Lint/Format（ESLint/Prettier）。`.env` で注入する必要キーと利用箇所を指示する（サンプルファイルは生成しない）。
- TypeScript: JavaScript と同様に加え、`tsc --noEmit` による型チェックと型境界設計を促す。抽象インターフェース経由の DI を強調する。
- Rust: `cargo` ワークスペース推奨、`cargo fmt` / `cargo clippy` / `cargo test`。feature flag 設計と実機テストの導線を含める。

## コンポーネントと依存関係
- `bin/bon.js`（エントリーポイント） → CLI パーサ → コンテキスト判定（ロケール/言語/エディタ） → テンプレート構成/レンダリング → ファイル出力。
- 依存は単方向（上位レイヤーが下位の抽象インターフェースに依存）。実装はインジェクション可能にし、ユニットテストでモックを差し替える。

## テスト戦略
- 単体テスト: CLI パーサ、ロケール/言語/エディタ判定、テンプレート組み立て、ファイル出力のエラーパス（上書き禁止など）。
- 結合テスト: 言語/エディタ/ロケールの組合せで AGENTS.md が期待どおりになるか確認。
- 実系テスト: 実ファイル書き出し、`.env` 指示文面の確認、`--force` の挙動、ヘルプ/バージョン出力。
- モックのみでは完了としない。実ファイル生成・実ロケール判定（可能な範囲）を通すことを完了条件に含める。

## 今後の拡張ポイント
- 言語追加時は TemplateProvider にスニペットを追加し、ロケール/エディタのメタ情報を組み合わせる。
- エディタ固有の指針（コマンド、制約、得意分野）を拡張可能なスキーマで管理する。
- WSL/Windows 言語推定の精度向上（レジストリ・PowerShell 呼び出しなど）はユーティリティ層に隔離し、失敗時は英語フォールバックを堅持する。
