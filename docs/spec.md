# bon-agents-md 仕様書

## フェーズ/グループ構成
- フェーズ1 (MVP): CLI/ロケール判定、テンプレート生成、ファイル出力・上書き制御。
- フェーズ2 (運用強化): ドキュメント/コメント運用ルールと言語・エディタ別ガイダンスの明示。
- フェーズ3 (拡張): 言語追加やテスト強化は別途章を追加して管理する。

### 1. コンテキスト判定（フェーズ1, F1）
- **1.1 [F1] ロケール判定の優先順位**
  - 前提 (Given): `LANG` または `LC_ALL` にロケール文字列が設定されている。
  - 条件 (When): `--lang` でプログラミング言語を指定せずに CLI を実行する。
  - 振る舞い (Then): `detectLocale` は `LANG`/`LC_ALL` → OS 推定の順で `ja` または `en` を決定し、判定不可の場合は英語を返す。
- **1.2 [F1] WSL のロケール判定**
  - 前提 (Given): プラットフォームが Linux で、カーネルリリース名に `microsoft` が含まれる。
  - 条件 (When): `detectLocale` がロケールを決定する。
  - 振る舞い (Then): Windows 側のロケール取得を試み、取得できればそれを優先して `ja`/`en` を決定する。
- **1.3 [F1] 言語・エディタ指定の正規化**
  - 前提 (Given): ユーザーが `--lang javascript` や `--editor Copilot` のようにエイリアスや大小混在で入力する。
  - 条件 (When): 引数パーサが入力を正規化する。
  - 振る舞い (Then): 言語は `js`/`ts` に正規化し、エディタは `codex`/`cursor`/`claudecode`/`copilot` のいずれかに正規化する。不正値はエラーを返す。

### 2. テンプレート構成（フェーズ1, F2）
- **2.1 [F2] ドキュメント参照の徹底**
  - 前提 (Given): `createTemplate` が AGENTS.md の本文を組み立てる。
  - 条件 (When): 生成するテンプレートに導入文と作業手順を含める。
  - 振る舞い (Then): `docs/concept.md`/`docs/spec.md`/`docs/architecture.md`/`docs/plan.md` を読むよう促し、プロジェクト固有情報は AGENTS.md に直接書かないよう明示する。
- **2.2 [F2] 必須セクションの配置**
  - 前提 (Given): 日本語/英語いずれのロケールも許容される。
  - 条件 (When): テンプレートをレンダリングする。
  - 振る舞い (Then): 要件定義・仕様記述（前提/条件/振る舞い or Given/When/Then）・設計方針・テスト方針・言語別指針・エディタ情報・作業の進め方を章立てで出力する。
- **2.3 [F2] 環境変数の扱い**
  - 前提 (Given): `.env.sample` は提供しない方針を採用している。
  - 条件 (When): 言語別指針を生成する。
  - 振る舞い (Then): 必要な環境変数/`.env` のキーと利用箇所を明示するよう指示し、`.env.sample` を生成しない旨を記載する。

### 3. ドキュメント/コメント運用ルール（フェーズ2, F3）
- **3.1 [F3] 日本語ドキュメントの徹底**
  - 前提 (Given): `detectLocale` が `ja` を返し、日本語テンプレートを生成する。
  - 条件 (When): テンプレートにドキュメント運用ルールを含める。
  - 振る舞い (Then): `docs/concept.md`/`docs/spec.md`/`docs/architecture.md`/`docs/plan.md` は必ず日本語で作成する旨を明記する。
- **3.2 [F3] コメントの二言語併記**
  - 前提 (Given): 日本語テンプレートを出力する。
  - 条件 (When): コードコメントに関する指針を示す。
  - 振る舞い (Then): ソースコードのコメントを日本語と英語で併記するよう明示する。
- **3.3 [F3] concept の構成**
  - 前提 (Given): 機能一覧やフェーズ整理を concept にまとめる方針を採用している。
  - 条件 (When): 日本語テンプレートを生成する。
  - 振る舞い (Then): 機能一覧を表形式で整理し、各機能の詳細説明と MVP/依存関係を明確化し、フェーズ単位で spec/architecture/plan を作成するよう指示する。
- **3.4 [F3] spec の構成**
  - 前提 (Given): concept で機能グループが定義されている。
  - 条件 (When): 日本語テンプレートを生成する。
  - 振る舞い (Then): spec は機能グループごとに章を分け、各仕様に番号を振り、前提/条件/振る舞い（Given/When/Then）形式で記載するよう指示する。

### 4. 出力と上書き制御（フェーズ1, F2）
- **4.1 [F2] --dir を指定した場合、ディレクトリを再帰的に作成する**
  - 前提 (Given): `--dir` で未作成のパスが指定されている。
  - 条件 (When): CLI がファイル出力を実行する。
  - 振る舞い (Then): 対象ディレクトリを再帰的に作成し、失敗時はエラーを返す。
- **4.2 [F2] 上書き防止**
  - 前提 (Given): 対象ファイルが既に存在する。
  - 条件 (When): `--force` を付けずに CLI を実行する。
  - 振る舞い (Then): 上書きを拒否しエラー終了する。`--force` 指定時は上書きする。
- **4.3 [F2] エディタ別ファイル名**
  - 前提 (Given): `--editor` オプションで `cursor` または `copilot` が指定される可能性がある。
  - 条件 (When): 出力ファイル名を決定する。
  - 振る舞い (Then): codex/claudecode は `AGENTS.md`、cursor は `.cursorrules`、copilot は `copilot-instructions.md` として保存する。

### 5. 言語・エディタ別ガイダンス（フェーズ2, F4）
- **5.1 [F4] 言語別の推奨セットアップ**
  - 前提 (Given): `--lang` で Python/JS/TS/Rust が指定される。
  - 条件 (When): 言語別指針をレンダリングする。
  - 振る舞い (Then): 言語に応じたツールチェーン（Python: `uv`+`pytest`、JS/TS: Node.js + テスト/ESLint/Prettier、Rust: cargo fmt/clippy/test）と環境変数の扱いを明示する。
- **5.2 [F4] エディタ別ターゲット表記**
  - 前提 (Given): `--editor` が指定される。
  - 条件 (When): テンプレート内のエディタ案内を生成する。
  - 振る舞い (Then): ターゲットとなるエディタ名を表示し、他のエディタを使う場合は `--editor` で切り替えるよう案内する。

### 6. 非機能・運用・エラー整理（横断）
- **6.1 性能/UX/i18n**
  - 前提 (Given): CLI 実行時にユーザーの操作をブロックしたくない。
  - 条件 (When): 主要フロー（解析・テンプレート生成・ファイル出力）を実行する。
  - 振る舞い (Then): サブ秒〜数秒で完了し、ロケールに応じたメッセージとテンプレートを返す。判定不可は英語フォールバック。
- **6.2 ログ/エラーメッセージ方針**
  - 前提 (Given): ユーザーが次の行動を理解できるメッセージが必要。
  - 条件 (When): 失敗や入力誤りが発生する。
  - 振る舞い (Then): 終了コードとエラーメッセージを出し、再実行方法やサポートする値を明示する。ライブラリ利用時は例外で呼び出し元がハンドリングできる形にする。
- **6.3 エラー/メッセージ一覧（管理用）**

| Error ID | シナリオ | 振る舞い/メッセージ例 |
| --- | --- | --- |
| E1 | 未サポートの `--lang` を指定 | エラー終了し、サポートされる言語を列挙して再入力を促す |
| E2 | 未サポートの `--editor` を指定 | エラー終了し、`codex|cursor|claudecode|copilot` を提示する |
| E3 | 既存ファイルに `--force` なしで上書きしようとした | エラー終了し、`--force` を付けるよう案内する |
| E4 | ディレクトリ作成に失敗 | エラー終了し、パスや権限を確認するメッセージを出す |
| E5 | ロケール判定失敗 | ログにフォールバックを記録し、英語テンプレートを生成する |
